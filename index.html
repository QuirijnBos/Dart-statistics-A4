<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Individual Player Stats Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    canvas { max-width: 100%; }
    .form-group { margin-bottom: 10px; }
    .player-avg { margin-top: 20px; }
    .player { margin: 5px 0; }
  </style>
</head>
<body>

  <h1>A4 Dart tracker</h1>

  <div class="form-group">
    <label>Player Name: <input type="text" id="playerName" /></label>
  </div>
  
  <div class="form-group">
    <label>Darts Thrown: <input type="number" id="score" /></label>
  </div>
  
  <button onclick="addScore()">Add Score</button>
  <button onclick="deleteLastScore()">Delete Last Score</button>
  <button onclick="deletePlayer()">Delete Player</button>

  <div class="player-avg">
    <h3>Player Averages</h3>
    <div id="playerAverages"></div>
  </div>

  <canvas id="gameChart" height="100"></canvas>

  <script>
    const ctx = document.getElementById('gameChart').getContext('2d');
    const playerData = {}; // { name: { x: [], y: [] } }

    // Create chart with an empty dataset initially
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [] // Empty dataset at the start
      },
      options: {
        responsive: true,
        animation: false,
        parsing: false, // We provide x/y manually
        scales: {
          x: {
            type: 'linear',
            beginAtZero: true,
            title: {
              display: true,
              text: 'Games Played'
            },
            ticks: {
              stepSize: 1,
              precision: 0
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Darts Thrown'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Player Dart Stats'
          }
        }
      }
    });

    // Save to localStorage
    function saveData() {
      localStorage.setItem('playerData', JSON.stringify(playerData));
    }

    // Load data from localStorage
    function loadData() {
      const saved = localStorage.getItem('playerData');
      if (saved) {
        const parsed = JSON.parse(saved);
        for (const name in parsed) {
          playerData[name] = parsed[name];

          chart.data.datasets.push({
            label: name,
            data: parsed[name].x.map((xVal, i) => ({
              x: xVal,
              y: parsed[name].y[i]
            })),
            borderColor: getRandomColor(),
            fill: false,
            tension: 0 // Straight lines
          });
        }
        chart.update();
        updatePlayerAverages();
      }
    }

    // Load data when page is opened
    loadData();

    function addScore() {
      const name = document.getElementById('playerName').value.trim();
      const score = parseInt(document.getElementById('score').value);

      if (!name || isNaN(score)) {
        alert("Please enter a valid name and score.");
        return;
      }

      if (!playerData[name]) {
        playerData[name] = { x: [], y: [] };
        chart.data.datasets.push({
          label: name,
          data: [],
          borderColor: getRandomColor(),
          fill: false,
          tension: 0
        });
      }

      const roundsPlayed = playerData[name].x.length + 1;
      playerData[name].x.push(roundsPlayed);
      playerData[name].y.push(score);

      const dataset = chart.data.datasets.find(d => d.label === name);
      dataset.data = playerData[name].x.map((xVal, i) => ({
        x: xVal,
        y: playerData[name].y[i]
      }));

      chart.update();
      saveData();
      updatePlayerAverages(); // Update averages immediately after adding score
    }

    function deleteLastScore() {
      const name = document.getElementById('playerName').value.trim();
      if (!name || !playerData[name] || playerData[name].x.length === 0) {
        alert("No scores to delete for this player.");
        return;
      }

      // Remove the last score (both x and y)
      playerData[name].x.pop();
      playerData[name].y.pop();

      // Update the chart data
      const dataset = chart.data.datasets.find(d => d.label === name);
      if (dataset) {
        dataset.data = playerData[name].x.map((xVal, i) => ({
          x: xVal,
          y: playerData[name].y[i]
        }));
      }

      // If no data left for the player, remove their dataset from chart
      if (playerData[name].x.length === 0) {
        chart.data.datasets = chart.data.datasets.filter(d => d.label !== name);
      }

      chart.update();
      saveData();
      updatePlayerAverages(); // Update averages immediately after deletion
    }

    function deletePlayer() {
      const name = document.getElementById('playerName').value.trim();
      if (!name || !playerData[name]) {
        alert("Enter a valid existing player name to delete.");
        return;
      }

      // Remove from local data
      delete playerData[name];

      // Remove from chart
      chart.data.datasets = chart.data.datasets.filter(d => d.label !== name);
      chart.update();
      saveData();
      updatePlayerAverages(); // Update averages immediately after deletion
    }

    function clearAll() {
      if (!confirm("Are you sure you want to delete all data?")) return;

      // Clear everything
      for (const key in playerData) delete playerData[key];
      chart.data.datasets = [];
      chart.update();
      localStorage.removeItem('playerData');
      updatePlayerAverages(); // Clear averages after deleting all data
    }

    function updatePlayerAverages() {
      const playerAveragesDiv = document.getElementById('playerAverages');
      playerAveragesDiv.innerHTML = ''; // Clear existing averages

      // Display averages for all players
      for (const name in playerData) {
        const totalGoals = playerData[name].y.reduce((sum, score) => sum + score, 0);
        const average = totalGoals / playerData[name].y.length;
        const avgText = `${name}: Average - ${average.toFixed(2)}`;
        const playerDiv = document.createElement('div');
        playerDiv.classList.add('player');
        playerDiv.textContent = avgText;
        playerAveragesDiv.appendChild(playerDiv);
      }
    }

    function getRandomColor() {
      const r = Math.floor(Math.random() * 200);
      const g = Math.floor(Math.random() * 200);
      const b = Math.floor(Math.random() * 200);
      return `rgb(${r}, ${g}, ${b})`;
    }
  </script>

</body>
</html>
